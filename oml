#!/usr/bin/env bash
#
# Oh-My-Litecode (OML) - Unified Toolchain Manager
# Version: 0.1.0-alpha
# License: MIT
#
# Usage: oml <command> [options]
#

set -euo pipefail

OML_VERSION="0.1.0-alpha"
OML_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OML_TOOLS="$OML_ROOT/tools"
OML_HOTFIX="$OML_ROOT/hotfix"
OML_DOCS="$OML_ROOT/docs"
OML_SOLVE_ANDROID="$OML_ROOT/solve-android"
OML_OCT_DIR="${OML_OCT_DIR:-$OML_ROOT/../opencode-termux}"
OML_BUN_DIR="${OML_BUN_DIR:-$OML_ROOT/../bun-termux}"
OML_OCT_PLUGINS_DIR="${OML_OCT_PLUGINS_DIR:-$OML_ROOT/../opencode-plugins-termux}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Note: do not source scripts from ./tools directly.
# Many tool scripts are executable entrypoints with side effects at source time.

# Show help
_show_help() {
    cat <<EOF
Oh-My-Litecode (OML) v${OML_VERSION}
Unified Toolchain Manager for Termux/Android AI Development

Usage: oml <command> [options]

Commands:
  build       Unified build orchestrator (Termux first, GNU/Linux second)
    --project <name>   Project: opencode or bun
    --target <name>    termux-dpkg | termux-pacman | gnu-debian | gnu-arch
    --ver <version>    Target version (default: opencode=latest, bun=1.3.9)
    --odir <dir>       Output directory (optional)
    --mix              Flatten output layout when supported
    --debug            Build debug mode when supported
    --dry-run          Print command only

    Legacy compatibility:
      --pkgmgr <type>  pacman | dpkg (mapped to termux targets)

  hotfix      Manage hotfixes
    list               List available hotfixes
    apply <name>       Apply a hotfix
    create <name>      Create new hotfix template

  doc         View documentation
    <project>          Project name (opencode, bun, oml)
    <topic>            Topic (optional)

  opencode    Manage opencode-termux integration (Termux first, GNU/Linux second)
    help                      Show opencode subcommand help
    path                      Show resolved OCT paths
    diagnose                  Run read-only diagnostics (selfcheck + key file checks)
    plugin <action> [args]    Forward to plugin-manager.sh (install/update/rollback/...)
    skill list                List system skill manifests (source + installed)
    skill hook <event>        Trigger run-system-skills.sh with event (post_install/post_upgrade)
    matrix --vers "..."       Run machine1->machine2 matrix via OCT Makefile/tools
    build [--ver V] [--pkg P] Build via OCT Makefile (default deb)
    plugin-build ...           Build external plugin packages via opencode-plugins-termux

  version     Show version info
  help        Show this help

Examples:
  oml build --project opencode --target termux-dpkg --ver 1.2.10
  oml build --project opencode --target gnu-arch --ver 1.2.10
  oml build --project bun --target termux-pacman --ver 1.3.9
  oml hotfix list
  oml doc opencode installation
  oml opencode diagnose
  oml opencode plugin install
  oml opencode skill hook post_upgrade
  oml opencode plugin-build --plugin omo --odir ~/oct-plugin-out

Projects:
  opencode    OpenCode for Termux with TTY/lock cleanup launcher
  bun         Bun runtime for Termux (glibc-runner wrapper)

EOF
}

# Build command
_cmd_build() {
    local ver=""
    local pkgmgr=""
    local project=""
    local target=""
    local debug=false
    local odir=""
    local mix=false
    local dry_run=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --ver) ver="$2"; shift 2 ;;
            --pkgmgr) pkgmgr="$2"; shift 2 ;;
            --project) project="$2"; shift 2 ;;
            --target) target="$2"; shift 2 ;;
            --odir) odir="$2"; shift 2 ;;
            --mix) mix=true; shift ;;
            --debug) debug=true; shift ;;
            --dry-run) dry_run=true; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$project" ]]; then
        echo -e "${RED}Error: --project is required (opencode or bun)${NC}"
        return 1
    fi

    if [[ -z "$target" ]]; then
        case "$pkgmgr" in
            pacman) target="termux-pacman" ;;
            dpkg|deb) target="termux-dpkg" ;;
            "") target="termux-dpkg" ;;
            *)
                echo -e "${RED}Error: unsupported --pkgmgr value: $pkgmgr${NC}"
                return 1
                ;;
        esac
    fi

    local pkg=""
    case "$target" in
        termux-dpkg|gnu-debian) pkg="deb" ;;
        termux-pacman|gnu-arch) pkg="pacman" ;;
        *)
            echo -e "${RED}Error: unsupported --target: $target${NC}"
            return 1
            ;;
    esac

    if [[ "$project" == "opencode" ]]; then
        _require_oct_repo || return 1
        [[ -n "$ver" ]] || ver="latest"

        local cmd=(make -C "$OML_OCT_DIR" all "VER=$ver" "PKG=$pkg")
        [[ -n "$odir" ]] && cmd+=("ODIR=$odir")
        [[ "$mix" == true ]] && cmd+=("MIX=1")

        echo -e "${BLUE}[oml] build opencode target=${target} ver=${ver}${NC}"
        if [[ "$dry_run" == true ]]; then
            printf '%q ' "${cmd[@]}"
            printf '\n'
            return 0
        fi
        "${cmd[@]}"
        return 0
    fi

    if [[ "$project" == "bun" ]]; then
        if [[ "$target" == gnu-* ]]; then
            echo -e "${RED}Error: bun-termux is Termux-only in current roadmap; GNU targets are disabled${NC}"
            return 1
        fi
        [[ -n "$ver" ]] || ver="1.3.9"

        if [[ ! -d "$OML_BUN_DIR" ]]; then
            echo -e "${RED}Error: bun-termux repo not found: $OML_BUN_DIR${NC}"
            return 1
        fi

        if [[ "$pkg" == "pacman" ]]; then
            local cmd=(make -C "$OML_BUN_DIR" package "PKGVER=$ver" "PKGMGR=pacman")
            echo -e "${BLUE}[oml] build bun target=${target} ver=${ver}${NC}"
            if [[ "$dry_run" == true ]]; then
                printf '%q ' "${cmd[@]}"
                printf '\n'
                return 0
            fi
            "${cmd[@]}"
            return 0
        fi

        local deb_cmd=(bash scripts/package/package_deb.sh)
        echo -e "${BLUE}[oml] build bun target=${target} ver=${ver}${NC}"
        if [[ "$dry_run" == true ]]; then
            printf 'cd %q && VERSION=%q ' "$OML_BUN_DIR" "$ver"
            printf '%q ' "${deb_cmd[@]}"
            printf '\n'
            return 0
        fi
        (cd "$OML_BUN_DIR" && VERSION="$ver" "${deb_cmd[@]}")
        if [[ -n "$odir" ]]; then
            mkdir -p "$odir"
            cp -f "$OML_BUN_DIR"/packaging/dpkg/bun_"$ver"_*.deb "$odir"/ 2>/dev/null || true
        fi
        return 0
    fi

    echo -e "${RED}Error: unsupported --project: $project${NC}"
    return 1
}

# Hotfix command
_cmd_hotfix() {
    local action="${1:-list}"

    case $action in
        list)
            echo -e "${BLUE}Available hotfixes:${NC}"
            for fix in "$OML_HOTFIX"/*.sh; do
                [[ -f "$fix" ]] && echo "  - $(basename "$fix" .sh)"
            done
            ;;
        apply)
            local name="$2"
            if [[ -z "$name" ]]; then
                echo -e "${RED}Error: hotfix name required${NC}"
                return 1
            fi
            local fix="$OML_HOTFIX/${name}.sh"
            if [[ ! -f "$fix" ]]; then
                echo -e "${RED}Error: hotfix '$name' not found${NC}"
                return 1
            fi
            echo -e "${BLUE}Applying hotfix: $name${NC}"
            source "$fix"
            ;;
        create)
            local name="$2"
            if [[ -z "$name" ]]; then
                echo -e "${RED}Error: hotfix name required${NC}"
                return 1
            fi
            cat > "$OML_HOTFIX/${name}.sh" <<'TEMPLATE'
#!/usr/bin/env bash
# Hotfix: <description>
# Created: $(date +%Y-%m-%d)
# Applies to: <project(s)>

set -euo pipefail

echo "Applying hotfix: <name>"
# Add fix logic here
TEMPLATE
            chmod +x "$OML_HOTFIX/${name}.sh"
            echo -e "${GREEN}Created hotfix template: $name${NC}"
            ;;
        *)
            echo -e "${RED}Unknown hotfix action: $action${NC}"
            return 1
            ;;
    esac
}

# Doc command
_cmd_doc() {
    local project="${1:-oml}"
    local topic="${2:-README}"

    local doc_file="$OML_DOCS/${project}/${topic}.md"

    if [[ -f "$doc_file" ]]; then
        ${PAGER:-less} "$doc_file"
    else
        echo -e "${YELLOW}Documentation not found: $doc_file${NC}"
        echo -e "${BLUE}Available docs for $project:${NC}"
        find "$OML_DOCS/$project" -name "*.md" 2>/dev/null | head -20 || echo "  (none)"
    fi
}

# Version command
_cmd_version() {
    echo "Oh-My-Litecode v${OML_VERSION}"
    echo ""
    echo "Sub-projects:"
    for proj in "$OML_SOLVE_ANDROID"/*; do
        [[ -d "$proj" ]] && echo "  - $(basename "$proj")"
    done
}

_oml_platform_label() {
    if [[ -d "/data/data/com.termux/files/usr" ]]; then
        echo "termux"
    else
        echo "gnu-linux"
    fi
}

_require_oct_repo() {
    if [[ ! -d "$OML_OCT_DIR" ]]; then
        echo -e "${RED}Error: opencode-termux repo not found: $OML_OCT_DIR${NC}"
        echo "Set OML_OCT_DIR to your opencode-termux path."
        return 1
    fi
    return 0
}

_cmd_opencode_help() {
    cat <<EOF
Usage: oml opencode <action> [subargs]

Actions:
  path
    Show resolved opencode-termux paths and platform label.

  diagnose
    Run read-only diagnostics via OCT selfcheck and key path inspection.

  plugin <action> [args]
    Forward to: tools/plugin-manager.sh
    Examples:
      oml opencode plugin install
      oml opencode plugin update
      oml opencode plugin rollback oh-my-opencode

  skill list
    List source/installed system skill manifests.

  skill hook <event>
    Trigger system skill hook runner with event.
    Example:
      oml opencode skill hook post_upgrade

  matrix --vers "<versions>" [--odir DIR] [--host H] [--port P] [--user U]
    Run OCT upgrade matrix simulation.

  build [--ver V] [--pkg deb|pacman|both] [--odir DIR]
    Build through OCT Makefile.

  plugin-build [--plugin KEY] [--mode source] [--odir DIR] [--mix]
    Build external plugin packages via opencode-plugins-termux.
    Example:
      oml opencode plugin-build --plugin qwen-oauth-gd --odir ~/oct-plugin-out

Notes:
  - Priority policy: Termux first, GNU/Linux second.
  - This command never assumes other OS environments.
EOF
}

_cmd_opencode() {
    _require_oct_repo || return 1

    local action="${1:-help}"
    shift || true

    local platform
    platform="$(_oml_platform_label)"

    case "$action" in
        help|--help|-h)
            _cmd_opencode_help
            ;;
        path)
            echo "platform=$platform"
            echo "oct_repo=$OML_OCT_DIR"
            echo "oct_makefile=$OML_OCT_DIR/Makefile"
            echo "oct_tools=$OML_OCT_DIR/tools"
            ;;
        diagnose)
            echo -e "${BLUE}[oml] opencode diagnose on ${platform}${NC}"
            if [[ -x "$OML_OCT_DIR/tools/plugin-selfcheck.sh" ]]; then
                (cd "$OML_OCT_DIR" && bash tools/plugin-selfcheck.sh)
            else
                echo -e "${YELLOW}warn: missing tool: $OML_OCT_DIR/tools/plugin-selfcheck.sh${NC}"
            fi
            local pfx="${PREFIX:-/data/data/com.termux/files/usr}"
            ls -l "$pfx/lib/opencode/tools/run-system-skills.sh" "$pfx/lib/opencode/system-skills" 2>/dev/null || true
            ;;
        plugin|manage)
            local sub="${1:-}"
            shift || true
            if [[ -z "$sub" ]]; then
                echo -e "${RED}Error: plugin action is required${NC}"
                return 1
            fi
            if [[ ! -x "$OML_OCT_DIR/tools/plugin-manager.sh" ]]; then
                echo -e "${RED}Error: missing executable: $OML_OCT_DIR/tools/plugin-manager.sh${NC}"
                return 1
            fi
            (cd "$OML_OCT_DIR" && bash tools/plugin-manager.sh "$sub" "$@")
            ;;
        skill|skills)
            local sub="${1:-list}"
            shift || true
            case "$sub" in
                list)
                    echo "[source manifests]"
                    ls -1 "$OML_OCT_DIR/packaging/manifests/system-skills"/*.json 2>/dev/null || echo "(none)"
                    echo "[installed manifests]"
                    ls -1 "${PREFIX:-/data/data/com.termux/files/usr}/lib/opencode/system-skills"/*.json 2>/dev/null || echo "(none)"
                    ;;
                hook)
                    local event="${1:-post_upgrade}"
                    local runner="$OML_OCT_DIR/scripts/hooks/run-system-skills.sh"
                    if [[ ! -x "$runner" ]]; then
                        echo -e "${RED}Error: missing executable: $runner${NC}"
                        return 1
                    fi
                    (cd "$OML_OCT_DIR" && bash "$runner" "$event")
                    ;;
                *)
                    echo -e "${RED}Unknown skill action: $sub${NC}"
                    return 1
                    ;;
            esac
            ;;
        matrix)
            local vers=""
            local odir=""
            local host=""
            local port=""
            local user=""
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --vers) vers="$2"; shift 2 ;;
                    --odir) odir="$2"; shift 2 ;;
                    --host) host="$2"; shift 2 ;;
                    --port) port="$2"; shift 2 ;;
                    --user) user="$2"; shift 2 ;;
                    *) echo -e "${YELLOW}warn: unknown arg: $1${NC}"; shift ;;
                esac
            done
            if [[ -z "$vers" ]]; then
                echo -e "${RED}Error: --vers is required${NC}"
                return 1
            fi
            local cmd=(make -C "$OML_OCT_DIR" matrix "VERS=$vers")
            [[ -n "$odir" ]] && cmd+=("ODIR=$odir")
            [[ -n "$host" ]] && cmd+=("TARGET_HOST=$host")
            [[ -n "$port" ]] && cmd+=("TARGET_PORT=$port")
            [[ -n "$user" ]] && cmd+=("TARGET_USER=$user")
            "${cmd[@]}"
            ;;
		build)
            local ver="latest"
            local pkg="deb"
            local odir=""
            while [[ $# -gt 0 ]]; do
                case "$1" in
                    --ver) ver="$2"; shift 2 ;;
                    --pkg) pkg="$2"; shift 2 ;;
                    --odir) odir="$2"; shift 2 ;;
                    *) echo -e "${YELLOW}warn: unknown arg: $1${NC}"; shift ;;
                esac
            done
			if [[ -n "$odir" ]]; then
				make -C "$OML_OCT_DIR" all "VER=$ver" "PKG=$pkg" "ODIR=$odir"
			else
				make -C "$OML_OCT_DIR" all "VER=$ver" "PKG=$pkg"
			fi
			;;
		plugin-build)
			local plugin="omo"
			local mode="source"
			local odir=""
			local mix="0"
			while [[ $# -gt 0 ]]; do
				case "$1" in
					--plugin) plugin="$2"; shift 2 ;;
					--mode) mode="$2"; shift 2 ;;
					--odir) odir="$2"; shift 2 ;;
					--mix) mix="1"; shift ;;
					*) echo -e "${YELLOW}warn: unknown arg: $1${NC}"; shift ;;
				esac
			done
			if [[ ! -d "$OML_OCT_PLUGINS_DIR" ]]; then
				echo -e "${RED}Error: plugin builder repo not found: $OML_OCT_PLUGINS_DIR${NC}"
				return 1
			fi
			if [[ -n "$odir" ]]; then
				make -C "$OML_OCT_PLUGINS_DIR" all "PLUGIN=$plugin" "MODE=$mode" "ODIR=$odir" "MIX=$mix"
			else
				make -C "$OML_OCT_PLUGINS_DIR" all "PLUGIN=$plugin" "MODE=$mode" "MIX=$mix"
			fi
			;;
        *)
            echo -e "${RED}Unknown opencode action: $action${NC}"
            _cmd_opencode_help
            return 1
            ;;
    esac
}

# Main entry point
main() {
    local cmd="${1:-help}"
    shift || true

    case $cmd in
        build)   _cmd_build "$@" ;;
        hotfix)  _cmd_hotfix "$@" ;;
        doc)     _cmd_doc "$@" ;;
        opencode) _cmd_opencode "$@" ;;
        version|--version|-v) _cmd_version ;;
        help|--help|-h) _show_help ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            _show_help
            exit 1
            ;;
    esac
}

main "$@"
