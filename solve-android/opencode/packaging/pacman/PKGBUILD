# PKGBUILD for OpenCode on Termux
# Package: opencode-termux
# Version: 1.1.65
# License: MIT

pkgname=opencode-termux
pkgver=1.1.65
pkgrel=1
pkgdesc='OpenCode for Termux with TTY+lock cleanup launcher (OCT)'
arch=('aarch64')
url='https://github.com/anomalyco/opencode'
license=('MIT')
options=('!strip' '!debug')
depends=('bash' 'ncurses' 'bun-termux')
makedepends=()
optdepends=('oh-my-litecode: hotfix and upgrade support')
source=()
sha256sums=()

# For local builds, set this to your source directory
_srcdir="${OPENCODE_SRC_DIR:-${PWD}/../../sources/opencode}"
_runtime="${OPENCODE_RUNTIME:-${PWD}/../../runtime/opencode-termux}"

prepare() {
    msg "Preparing OpenCode source..."
    # Source preparation happens in build script
}

build() {
    msg "Building OpenCode staged prefix..."
    
    local prefix="${pkgdir}/data/data/com.termux/files/usr"
    
    # Create directories
    mkdir -p "$prefix/lib/opencode/runtime"
    mkdir -p "$prefix/bin"
    
    # Copy source (excluding git and node_modules)
    if [ -d "$_srcdir" ]; then
        msg2 "Copying source from $_srcdir"
        rsync -a --exclude='.git' --exclude='node_modules' \
            "$_srcdir/" "$prefix/lib/opencode/" || \
        cp -a "$_srcdir/." "$prefix/lib/opencode/"
    fi
    
    # Copy runtime if available
    if [ -f "$_runtime" ]; then
        msg2 "Installing runtime"
        install -m755 "$_runtime" "$prefix/lib/opencode/runtime/opencode"
    fi
    
    # Create launcher
    cat > "$prefix/bin/opencode" <<'LAUNCHER'
#!/usr/bin/env bash
# OpenCode for Termux Launcher
# Part of Oh-My-Litecode project

set -euo pipefail

SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OPENCODE_CLI="$SELF_DIR/../lib/opencode/packages/opencode/bin/opencode"
OPENCODE_RUNTIME="$SELF_DIR/../lib/opencode/runtime/opencode"

# Cleanup functions
cleanup_state_locks() {
    local state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/opencode"
    if [ -d "$state_dir" ]; then
        find "$state_dir" -maxdepth 1 -type f -name '*.lock' -delete 2>/dev/null || true
    fi
}

cleanup_broken_cached_modules() {
    local cache_root="${XDG_CACHE_HOME:-$HOME/.cache}/opencode"
    local mod_dir="$cache_root/node_modules/opencode-anthropic-auth"
    if [ -d "$mod_dir" ] && [ ! -f "$mod_dir/package.json" ]; then
        rm -rf "$cache_root/node_modules" 2>/dev/null || true
    fi
}

ensure_stdio_tty() {
    if [ -t 0 ] && [ -t 1 ] && [ -w /dev/tty ]; then
        exec </dev/tty >/dev/tty 2>/dev/tty
    fi
}

cleanup_tty() {
    if [ -t 1 ]; then
        printf '\033[?1049l\033[?25h\033[0m' >/dev/tty 2>/dev/null || true
    fi
    command -v stty >/dev/null 2>&1 && stty sane 2>/dev/null || true
    command -v tput >/dev/null 2>&1 && tput rmcup >/dev/null 2>&1 || true
}

trap cleanup_tty EXIT INT TERM HUP QUIT

ensure_stdio_tty
cleanup_state_locks
cleanup_broken_cached_modules

# Disable default plugins by default (avoid EACCES on Termux)
: "${OPENCODE_DISABLE_DEFAULT_PLUGINS:=1}"
export OPENCODE_DISABLE_DEFAULT_PLUGINS

# Execute
if [[ -x "$OPENCODE_RUNTIME" ]]; then
    "$OPENCODE_RUNTIME" "$@"
    exit $?
fi

"$OPENCODE_CLI" "$@"
LAUNCHER
    chmod 755 "$prefix/bin/opencode"
}

package() {
    msg "Packaging OpenCode..."
    # Package is already built in build()
    true
}

# Post-install message
post_install() {
    echo ""
    echo "OpenCode for Termux installed successfully!"
    echo ""
    echo "Usage:"
    echo "  opencode           - Start OpenCode TUI"
    echo "  opencode web       - Start web interface"
    echo "  opencode --help    - Show help"
    echo ""
    echo "Note: OPENCODE_DISABLE_DEFAULT_PLUGINS=1 is set by default"
    echo "to avoid EACCES errors on Termux."
    echo ""
}
